<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0F172A">
    <title>QueVend√≠ PRO</title>

    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QueVendi">
    <link rel="apple-touch-icon" href="/static/img/icon-192.png">

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/voice_simple.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/modal_commands.css">
    
    <!-- AUTH CHECK (ejecutar antes de cargar el body) -->
    <!-- ‚úÖ CONFIGURACI√ìN HTMX - SOLO UNA VEZ -->

        <!-- Cargar nuevos archivos -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/cart.css') }}">
    <script src="{{ url_for('static', path='/js/product_search.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Configurando HTMX con token...');
            
            // Agregar token a todas las peticiones HTMX
            document.body.addEventListener('htmx:configRequest', function(event) {
                const token = localStorage.getItem('access_token');
                if (token) {
                    event.detail.headers['Authorization'] = `Bearer ${token}`;
                    console.log('[HTMX] ‚úÖ Token agregado a:', event.detail.path);
                } else {
                    console.warn('[HTMX] ‚ö†Ô∏è No hay token para:', event.detail.path);
                }
            });
            
            // ‚ùå TEMPORALMENTE DESHABILITADO - PARA DEBUG
            /*
            document.body.addEventListener('htmx:responseError', function(event) {
                if (event.detail.xhr.status === 401) {
                    console.log('[Auth] ‚ùå 401 - Redirigiendo a login');
                    localStorage.clear();
                    window.location.href = '/auth/login';
                }
            });
            */
            
            console.log('[HTMX] ‚úÖ Configuraci√≥n aplicada');
        });
    </script>

        <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <style>

        .catalog-card.catalog-loaded {
            pointer-events: none;
            position: relative;
        }

        .catalog-card.catalog-loaded::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 255, 255, 0.03) 10px,
                rgba(255, 255, 255, 0.03) 20px
            );
            pointer-events: none;
            border-radius: 16px;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Estilos Onboarding */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .onboarding-container {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 24px;
            max-width: 900px;
            width: 100%;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .onboarding-header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .onboarding-header h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .onboarding-header p {
            font-size: 18px;
            opacity: 0.9;
        }

        .catalogs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .catalog-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease; /* ‚¨ÖÔ∏è Cambiar a 0.2s para respuesta r√°pida */
            color: white;
            position: relative;
        }

        .catalog-card:hover {
            transform: translateY(-5px) scale(1.02); /* ‚¨ÖÔ∏è Feedback inmediato */
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
        }

        .catalog-card:active {
            transform: translateY(0) scale(0.98); /* ‚¨ÖÔ∏è Feedback al presionar */
            transition: all 0.1s ease;
        }

        .catalog-card.loading {
            pointer-events: none;
            opacity: 0.6;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 0.8;
            }
        }

        .catalog-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .catalog-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .catalog-description {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .catalog-count {
            font-size: 12px;
            opacity: 0.7;
        }

        .onboarding-footer {
            text-align: center;
            color: white;
            opacity: 0.8;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }    

        /* Fix para selector de m√©todos de pago */

        /* Fix para selector de m√©todos de pago */
        .voice-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 20px !important;
            width: 100% !important;
            max-width: 100% !important;
            padding: 0 !important;
            box-sizing: border-box !important;
            flex-wrap: wrap !important; /* Para pantallas peque√±as */
            gap: 12px !important;
        }

        .payment-selector {
            display: flex !important;
            gap: 8px !important;
            align-items: center !important;
            flex-shrink: 0 !important;
        }

        .mic-status {
            flex: 1 !important;
            min-width: 120px !important;
            cursor: pointer !important;
            user-select: none !important;
            -webkit-tap-highlight-color: rgba(16, 185, 129, 0.3) !important;
        }

        .mic-status:active {
            transform: scale(0.95);
            background: rgba(16, 185, 129, 0.3) !important;
        }

        .payment-btn {
            padding: 8px 16px !important;
            border-radius: 8px !important;
            border: none !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.2s !important;
            white-space: nowrap !important;
        }

        .payment-btn.active {
            transform: scale(1.05) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }

        .payment-icon {
        width: 16px;
        height: 16px;
        color: #10b981;
    }

    /* Fix para modal de comandos */
        .modal.show {
            display: flex !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
    </style>

    <style>
        /* Estilos del Avatar */
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .avatar-preview {
            width: 200px;
            height: 200px;
            margin: 0 auto 1rem;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #667eea;
            background: #f5f5f5;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>

    <style>
    .install-button {
        position: fixed;
        top: 70px;
        right: 20px;
        z-index: 1000;
        padding: 12px 20px;
        background: linear-gradient(135deg, #4cd964, #5ac8fa);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(76, 217, 100, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .install-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(76, 217, 100, 0.4);
    }

    .install-button:active {
        transform: translateY(0);
    }

    .install-icon {
        font-size: 18px;
    }

    .install-text {
        font-size: 14px;
    }

    /* Mobile */
    @media (max-width: 768px) {
        .install-button {
            top: auto;
            bottom: 80px;
            right: 20px;
            padding: 14px 24px;
        }
    }
    </style>
</head>
<body class="theme-darkpro">

    <!-- Contenedor del carrito -->
    <div id="cart-container"></div>

    <!-- Bot√≥n de instalaci√≥n mejorado -->
    <button id="install-btn" class="install-button" style="display: none;">
        <span class="install-icon">üì±</span>
        <span class="install-text">Instalar App</span>
    </button>
    
    <!-- Loading Screen - AGREGAR ESTO -->
    <div id="loading-screen" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        color: white;
    ">
        <div style="text-align: center;">
            <div style="
                width: 60px;
                height: 60px;
                border: 6px solid rgba(255, 255, 255, 0.3);
                border-top-color: #4CAF50;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            "></div>
            <h2>Cargando QueVendi...</h2>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL ONBOARDING (AGREGAR AQU√ç) -->
    <!-- ============================================ -->
    <div id="onboarding-modal" style="display: none;">
        <div class="onboarding-overlay">
            <div class="onboarding-container">
                <div class="onboarding-header">
                    <!-- ‚¨áÔ∏è NUEVO: Contenedor flex para t√≠tulo + bot√≥n ‚¨áÔ∏è -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        width: 100%;
                        margin-bottom: 10px;
                    ">
                        <div style="flex: 1;">
                            <h2>üéâ ¬°Bienvenido a QueVendi!</h2>
                            <p>Selecciona el tipo de cat√°logo para tu negocio</p>
                        </div>
                        
                        <!-- ‚¨áÔ∏è NUEVO: Bot√≥n Volver ‚¨áÔ∏è -->
                        <button onclick="closeOnboardingWizard()" style="
                            background: rgba(255, 255, 255, 0.2);
                            border: 2px solid rgba(255, 255, 255, 0.5);
                            color: white;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: bold;
                            font-size: 14px;
                            transition: all 0.3s ease;
                            white-space: nowrap;
                            flex-shrink: 0;
                        " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.borderColor='white'"
                        onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.borderColor='rgba(255, 255, 255, 0.5)'">
                            ‚Üê Volver a ventas
                        </button>
                    </div>
                </div>
                
                <div id="catalogs-grid" class="catalogs-grid">
                    <!-- Se llena din√°micamente -->
                </div>
                
                <div class="onboarding-footer">
                    <p>üí° Podr√°s agregar, editar o eliminar productos despu√©s</p>
                </div>
            </div>
        </div>
    </div>

        <!-- ============================================ -->
        <!-- FIN MODAL ONBOARDING -->
        <!-- ============================================ -->
        <!-- Aqu√≠ contin√∫a tu contenido actual de home.html -->

    <div class="container" style="display: none;" id="main-content">
        

        <!-- HEADER FIJO - ACTUALIZADO CON CONFIGURACI√ìN -->
        <div class="header">
            <!-- Avatar clickeable -->
            <img 
                class="user-avatar" 
                id="user-avatar" 
                src="/static/img/default-avatar.webp" 
                alt="Usuario" 
                onclick="openAvatarModal()"
                style="cursor: pointer;"
            >
            
            <div class="header-info">
                <div class="store-name" id="store-name">Cargando...</div>
                <div class="store-meta" id="user-name">...</div>
            </div>
            
            <div class="header-actions">
                <!-- Bot√≥n Configuraci√≥n (solo owners) -->
                <a href="/settings" 
                id="settings-btn" 
                class="icon-btn" 
                title="Configuraci√≥n"
                style="display: none; text-decoration: none; color: inherit;">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6m5.66-13A10 10 0 0 1 12 22m5.66-13a10 10 0 0 0 0 0"></path>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path>
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="4.93" y1="4.93" x2="9.17" y2="9.17"></line>
                        <line x1="14.83" y1="14.83" x2="19.07" y2="19.07"></line>
                        <line x1="14.83" y1="9.17" x2="19.07" y2="4.93"></line>
                        <line x1="4.93" y1="19.07" x2="9.17" y2="14.83"></line>
                    </svg>
                </a>
                
                <!--
                <button class="icon-btn" onclick="openCommandsModal()" title="Ver comandos de voz">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </button>
                -->
                
                <button class="icon-btn" onclick="handleLogout()" title="Cerrar sesi√≥n">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>

        <script>
        // Mostrar bot√≥n de configuraci√≥n solo para owners
        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;
            
            if (user && user.role === 'owner') {
                document.getElementById('settings-btn').style.display = 'flex';
            }
        });
        </script>
        <!-- FIN HEADER FIJO -->

        <!-- ESTADO DEL MICR√ìFONO -->
        <div class="voice-header">
            <div id="mic-status" class="mic-status">üé§ INICIANDO...</div>
            <div class="payment-selector">
                <button class="payment-btn active" data-method="efectivo" title="Efectivo">
                    <span class="payment-label">S/.</span>
                </button>
                <button class="payment-btn" data-method="yape" title="Yape">
                    <span class="payment-label">Yape</span>
                </button>
                <button class="payment-btn" data-method="plin" title="Plin">
                    <span class="payment-label">Plin</span>
                </button>
            </div>
        </div>

        <!-- STICKY SECTION: Resumen + Botones -->
        <div class="sticky-section">
            <!-- 1. RESUMEN DEL D√çA (sticky-section) -->
            <div class="summary-compact" id="daily-summary" 
                hx-get="/api/v1/sales/today/total/html" 
                hx-trigger="load, every 10s"
                hx-swap="innerHTML">
                <div class="card-loading">Cargando...</div>
            </div>

            <!-- Botones de acceso r√°pido -->
            <div class="quick-grid">
                <div class="quick-card" onclick="window.location.href='/products/manage'">
                    <div class="quick-icon">
                        <svg class="icon icon-lg" viewBox="0 0 24 24">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        </svg>
                    </div>
                    <div class="quick-label">Productos</div>
                </div>
                <div class="quick-card" onclick="alert('Pr√≥ximamente...')">
                    <div class="quick-icon">
                        <svg class="icon icon-lg" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                    </div>
                    <div class="quick-label">Compras</div>
                </div>
                <div class="quick-card" onclick="openFiadosModal()">
                    <div class="quick-icon">
                        <svg class="icon icon-lg" viewBox="0 0 24 24">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                    </div>
                    <div class="quick-label">Fiados</div>
                </div>
                <div class="quick-card" onclick="window.location.href='/reports'">
                    <div class="quick-icon">
                        <svg class="icon icon-lg" viewBox="0 0 24 24">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </div>
                    <div class="quick-label">Reportes</div>
                </div>
            </div>
        </div>

        <!-- CONTENT SCROLLABLE -->
        <div class="content-scrollable">
            <!-- Transcripci√≥n flotante -->
            <div id="transcript" style="display:none;"></div>

            <!-- CARRITO DE COMPRAS -->
            <div id="cart-display" class="cart-display">
                <div class="cart-empty">
                    <div class="empty-icon">üõí</div>
                    <div class="empty-text">Carrito vac√≠o</div>
                    <div class="empty-hint">Di: "un caf√© y 10 panes"</div>
                </div>
            </div>

            <!-- Ventas recientes -->
            <div class="section-header">
                <h3>Ventas recientes</h3>
            </div>
            <!-- 2. LISTA DE VENTAS (content-scrollable) -->
            <div id="sales-list" 
                hx-get="/api/v1/sales/today/html" 
                hx-trigger="load, salesUpdated from:body"
                hx-swap="innerHTML">
                <div class="card-loading">Cargando ventas...</div>
            </div>
        </div>

        <!-- BOTONES DE ACCI√ìN COMPACTOS (REEMPLAZAR EN home.html) -->
        <div class="action-buttons-compact">
            <button class="action-btn-small cancel" onclick="handleVoiceCommand('cancelar')" title="Cancelar venta">
                ‚úï
            </button>
            <button class="action-btn-small commands" onclick="openCommandsModal()" title="Ver comandos">
                ?
            </button>
            <button class="action-btn-small confirm" onclick="handleVoiceCommand('confirmar')" title="Confirmar venta">
                ‚úì
            </button>
        </div>
    </div>

    <!-- MODAL DE COMANDOS DE VOZ - VERSI√ìN REDISE√ëADA -->
    <div id="voice-commands-modal" class="modal">
        <div class="modal-content modal-commands">
            <div class="modal-header">
                <div class="modal-title-wrapper">
                    <div class="modal-icon">üé§</div>
                    <div>
                        <h2>Comandos de Voz</h2>
                        <p class="modal-subtitle">Habla natural, yo entiendo</p>
                    </div>
                </div>
                <button class="modal-close" onclick="closeCommandsModal()">‚úï</button>
            </div>
            
            <div class="modal-body">
                <!-- Grid de comandos -->
                <div class="commands-grid">
                    <!-- VENTAS -->
                    <div class="command-card">
                        <div class="command-card-header">
                            <span class="command-emoji">üõí</span>
                            <h3>Ventas</h3>
                        </div>
                        <div class="command-examples">
                            <div class="command-example">
                                <span class="example-text">"un caf√©" | "caf√© y 6 panes"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"10 panes"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"medio kilo de az√∫car"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"caf√© y 5 panes"</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AGREGAR -->
                    <div class="command-card">
                        <div class="command-card-header">
                            <span class="command-emoji">‚ûï</span>
                            <h3>Agregar</h3>
                        </div>
                        <div class="command-examples">
                            <div class="command-example">
                                <span class="example-text">"agregar leche"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"a√±ade 3 gaseosas"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"aumenta 6 panes"</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CONFIRMAR -->
                    <div class="command-card">
                        <div class="command-card-header">
                            <span class="command-emoji">‚úÖ</span>
                            <h3>Confirmar</h3>
                        </div>
                        <div class="command-examples">
                            <div class="command-example">
                                <span class="example-text">"listo" | "ok"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"total" | "cerrar"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"confirmar" | "sumar"</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CANCELAR -->
                    <div class="command-card">
                        <div class="command-card-header">
                            <span class="command-emoji">‚ùå</span>
                            <h3>Cancelar</h3>
                        </div>
                        <div class="command-examples">
                            <div class="command-example">
                                <span class="example-text">"cancelar" | "sacar"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"anular" | "borra"</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- QUITAR -->
                    <div class="command-card">
                        <div class="command-card-header">
                            <span class="command-emoji">üóëÔ∏è</span>
                            <h3>Quitar</h3>
                        </div>
                        <div class="command-examples">
                            <div class="command-example">
                                <span class="example-text">"quitar caf√©" | "sacar aceite"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"eliminar pan" | "borra agua"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"quita pan" | "resta gaseosa"</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CAMBIAR PRODUCTO -->
                    <div class="command-card">
                        <div class="command-card-header">
                            <span class="command-emoji">üîÑ</span>
                            <h3>Cambiar</h3>
                        </div>
                        <div class="command-examples">
                            <div class="command-example">
                                <span class="example-text">"cambiar caf√© por leche"</span>
                            </div>
                            <div class="command-example">
                                <span class="example-text">"leche a 5 soles"</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tips al final -->
                <div class="command-tips-box">
                    <div class="tips-title">üí° Tips</div>
                    <ul class="tips-list">
                        <li>Habla claro y natural</li>
                        <li>Usa "y" para m√∫ltiples productos</li>
                        <li>Puedes usar fracciones: "medio", "un cuarto"</li>
                        <li>El sistema est√° siempre escuchando</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY DE ORIENTACI√ìN -->
    <div id="orientation-overlay" class="orientation-overlay" style="display:none;"></div>

    <!-- CONTAINER DE ALERTAS -->
    <div id="alert-container" class="alert-container"></div>


    <!-- Modal de Avatar (agregar al final del body) -->
    <div id="avatar-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>üì∏ Foto de Perfil</h3>
                <button class="btn-close" onclick="closeAvatarModal()">‚úï</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div class="avatar-preview">
                    <img id="avatar-preview" src="/static/img/default-avatar.png" alt="Preview">
                </div>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                    JPG, PNG o GIF ‚Ä¢ M√°ximo 5MB
                </p>
                <input 
                    type="file" 
                    id="avatar-input" 
                    accept="image/jpeg,image/png,image/gif,image/webp"
                    style="display: none;"
                    onchange="handleAvatarSelect(event)"
                >
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-primary" onclick="document.getElementById('avatar-input').click()">
                        üì∑ Seleccionar
                    </button>
                    <button class="btn btn-success" onclick="uploadAvatar()" id="btn-upload-avatar" style="display: none;">
                        ‚úì Subir
                    </button>
                </div>
            </div>
        </div>
    </div>
</div> <!-- Cierre de #main-content -->

<!-- Banner Instalaci√≥n PWA -->
<div id="install-banner" style="
    position: fixed;
    bottom: 20px;
    left: 20px;
    right: 20px;
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    display: none;
    z-index: 9998;
    animation: slideUp 0.3s ease;
">
    <div style="display: flex; align-items: center; gap: 15px;">
        <div style="font-size: 40px;">üì±</div>
        <div style="flex: 1;">
            <h3 style="margin: 0 0 5px 0; font-size: 18px; font-weight: bold;">Instalar QueVendi</h3>
            <p style="margin: 0; font-size: 14px; opacity: 0.9;">Funciona sin internet y es m√°s r√°pido</p>
        </div>
        <button id="install-btn" style="
            padding: 12px 24px;
            background: white;
            color: #4CAF50;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        ">Instalar</button>
        <button id="dismiss-install" style="
            padding: 8px 12px;
            background: transparent;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        ">√ó</button>
    </div>
</div>

<!-- Indicador de ventas pendientes -->
<div id="pending-sales-indicator" style="
    position: fixed;
    top: 70px;
    right: 20px;
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 9997;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
" onclick="syncNow()">
    <span id="pending-count">0</span> ventas pendientes üîÑ
</div>

<style>
@keyframes slideUp {
    from {
        transform: translateY(100px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}
</style>

<script>

// ============================================
// PWA INSTALACI√ìN
// ============================================
let deferredPrompt;
const installButton = document.getElementById('install-btn');

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('[PWA] beforeinstallprompt disparado');
    // NO prevenir - dejar que Chrome muestre el banner
    // e.preventDefault();  ‚¨ÖÔ∏è COMENTAR ESTA L√çNEA
    
    deferredPrompt = e;
    
    // Mostrar bot√≥n de instalaci√≥n
    if (installButton) {
        installButton.style.display = 'flex';
    }
    
    // Mostrar banner si no est√° instalado y no fue rechazado recientemente
    /*
    const dismissed = localStorage.getItem('install-dismissed');
    const now = Date.now();
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    
    if (!window.matchMedia('(display-mode: standalone)').matches && 
        (!dismissed || now - dismissed > sevenDays)) {
        document.getElementById('install-banner').style.display = 'block';
    }
    */
});

// Click en bot√≥n de instalaci√≥n
if (installButton) {
    installButton.addEventListener('click', async () => {
        console.log('[PWA] Usuario clicke√≥ Instalar');
        
        if (!deferredPrompt) {
            console.log('[PWA] No hay prompt disponible');
            return;
        }
        
        // Mostrar prompt de instalaci√≥n
        deferredPrompt.prompt();
        
        // Esperar respuesta del usuario
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`[PWA] Usuario eligi√≥: ${outcome}`);
        
        // Limpiar
        deferredPrompt = null;
        installButton.style.display = 'none';
    });
}

// Detectar cuando ya est√° instalado
window.addEventListener('appinstalled', () => {
    console.log('[PWA] ‚úÖ App instalada exitosamente');
    if (installButton) {
        installButton.style.display = 'none';
    }
    deferredPrompt = null;
});

// Ocultar bot√≥n si ya est√° instalado
if (window.matchMedia('(display-mode: standalone)').matches) {
    console.log('[PWA] App ya est√° instalada');
    if (installButton) {
        installButton.style.display = 'none';
    }
}

function showInstallButton() {
    const installBtn = document.getElementById('install-btn');
    if (installBtn) {
        installBtn.style.display = 'block';
        
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`Install outcome: ${outcome}`);
                deferredPrompt = null;
                installBtn.style.display = 'none';
            }
        });
    }
}

document.getElementById('install-btn')?.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    console.log(`‚úÖ Usuario ${outcome === 'accepted' ? 'instal√≥' : 'rechaz√≥'} la app`);
    
    deferredPrompt = null;
    document.getElementById('install-banner').style.display = 'none';
});

document.getElementById('dismiss-install')?.addEventListener('click', () => {
    document.getElementById('install-banner').style.display = 'none';
    localStorage.setItem('install-dismissed', Date.now());
});

// ============================================
// SERVICE WORKER
// ============================================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
        try {
            const registration = await navigator.serviceWorker.register('/static/sw.js');
            console.log('‚úÖ SW registrado:', registration.scope);
            
            // Verificar actualizaciones cada hora
            setInterval(() => registration.update(), 60 * 60 * 1000);
            
            // Escuchar mensajes del SW
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'SYNC_COMPLETE') {
                    updatePendingSalesIndicator();
                }
            });
        } catch (error) {
            console.error('‚ùå Error registrando SW:', error);
        }
    });
}

// ============================================
// INDICADOR DE VENTAS PENDIENTES
// ============================================
async function updatePendingSalesIndicator() {
    try {
        // Verificar que localDB existe
        if (typeof localDB === 'undefined') {
            console.warn('[Indicator] localDB no disponible a√∫n');
            return;
        }
        
        await localDB.init();
        const pending = await localDB.getPendingSales();
        
        const indicator = document.getElementById('pending-sales-indicator');
        const count = document.getElementById('pending-count');
        
        if (!indicator || !count) {
            console.warn('[Indicator] Elementos DOM no encontrados');
            return;
        }
        
        if (pending.length > 0) {
            count.textContent = pending.length;
            indicator.style.display = 'block';
        } else {
            indicator.style.display = 'none';
        }
    } catch (error) {
        console.warn('[Indicator] Error:', error.message);
        // No mostrar error al usuario, solo loguear
    }
}


// Sincronizar manualmente
async function syncNow() {
    if ('serviceWorker' in navigator && 'sync' in navigator.serviceWorker) {
        const registration = await navigator.serviceWorker.ready;
        await registration.sync.register('sync-sales');
        
        // Feedback visual
        const indicator = document.getElementById('pending-sales-indicator');
        indicator.innerHTML = '‚è≥ Sincronizando...';
        
        setTimeout(updatePendingSalesIndicator, 2000);
    }
}

// Actualizar indicador cada 30 segundos
setInterval(updatePendingSalesIndicator, 30000);

// Actualizar al cargar
document.addEventListener('DOMContentLoaded', updatePendingSalesIndicator);

// ============================================
// DETECTOR DE CONEXI√ìN
// ============================================
window.addEventListener('online', () => {
    console.log('üü¢ Conexi√≥n restaurada');
    
    // Auto-sincronizar
    syncNow();
    
    // Notificar usuario
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Conexi√≥n restaurada', {
            body: 'Sincronizando ventas pendientes...',
            icon: '/static/img/icon-192.png'
        });
    }
});

window.addEventListener('offline', () => {
    console.log('üî¥ Sin conexi√≥n');
    
    // Notificar usuario
    const toast = document.createElement('div');
    toast.textContent = 'üì° Modo offline - Las ventas se sincronizar√°n autom√°ticamente';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #ff9800;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        z-index: 10000;
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 3000);
});
</script>

    <!-- ====================================
         SCRIPTS DE INICIALIZACI√ìN
         ==================================== -->
    <script>
    // ============================================
    // ONBOARDING WIZARD
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
        await checkOnboarding();
    });

        async function checkOnboarding() {
            try {
                // Obtener elementos del DOM
                const loadingScreen = document.getElementById('loading-screen');
                const mainContent = document.getElementById('main-content');
                
                // Si no existen los elementos, no hacer nada
                if (!loadingScreen || !mainContent) {
                    console.log('‚ö†Ô∏è Elementos de onboarding no encontrados');
                    return;
                }
                
                // Verificar si viene desde settings con par√°metro
                const urlParams = new URLSearchParams(window.location.search);
                const forceWizard = urlParams.has('show_catalog_wizard');
                
                if (forceWizard) {
                    console.log('üéØ Forzando wizard desde settings');
                    loadingScreen.style.display = 'none';
                    await showOnboardingWizard();
                    return;
                }
                
                // Obtener datos del usuario
                const userStr = localStorage.getItem('user');
                const user = userStr ? JSON.parse(userStr) : null;
                
                // Solo owners pueden ver el wizard
                if (!user || user.role !== 'owner') {
                    console.log('‚ö†Ô∏è Usuario no es owner, saltando onboarding');
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    return;
                }
                
                // Owner: verificar si necesita onboarding
                const response = await fetch('/api/v1/stores/me/onboarding-status', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.needs_onboarding) {
                    loadingScreen.style.display = 'none';
                    await showOnboardingWizard();
                } else {
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking onboarding:', error);
                
                const loadingScreen = document.getElementById('loading-screen');
                const mainContent = document.getElementById('main-content');
                
                if (loadingScreen) loadingScreen.style.display = 'none';
                if (mainContent) mainContent.style.display = 'block';
            }
        }

        async function showOnboardingWizard() {
            try {
                await localDB.init();
                
                // Obtener cat√°logo actual (solo uno)
                const currentCatalog = await localDB.getConfig('catalog_code');
                console.log('[Wizard] Cat√°logo actual:', currentCatalog);
                
                // Cargar cat√°logos disponibles
                const response = await fetch('/api/v1/catalogs/available');
                const data = await response.json();
                
                // Mostrar modal
                const modal = document.getElementById('onboarding-modal');
                modal.style.display = 'block';
                
                // Renderizar cat√°logos
                const grid = document.getElementById('catalogs-grid');
                grid.innerHTML = data.catalogs.map(catalog => {
                    const isActive = currentCatalog && currentCatalog.value === catalog.code;
                    
                    if (isActive) {
                        // Cat√°logo activo
                        return `
                            <div class="catalog-card" style="
                                position: relative;
                                border: 3px solid #4CAF50;
                                background: rgba(76, 175, 80, 0.1);
                            ">
                                <div style="
                                    position: absolute;
                                    top: 10px;
                                    right: 10px;
                                    background: #4CAF50;
                                    color: white;
                                    padding: 5px 12px;
                                    border-radius: 20px;
                                    font-size: 12px;
                                    font-weight: bold;
                                ">‚úÖ ACTIVO</div>
                                
                                <div class="catalog-icon">${catalog.icon}</div>
                                <div class="catalog-name">${catalog.name}</div>
                                <div class="catalog-description">${catalog.description}</div>
                                <div class="catalog-count">~${catalog.estimated_products} productos</div>
                                
                                <button onclick="event.stopPropagation(); resetAndLoadCatalog('${catalog.code}')" style="
                                    margin-top: 15px;
                                    background: #ff9800;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: bold;
                                ">
                                    üîÑ Recargar
                                </button>
                            </div>
                        `;
                    } else {
                        // Cat√°logo disponible
                        return `
                            <div class="catalog-card" onclick="confirmLoadCatalog('${catalog.code}', event)">
                                <div class="catalog-icon">${catalog.icon}</div>
                                <div class="catalog-name">${catalog.name}</div>
                                <div class="catalog-description">${catalog.description}</div>
                                <div class="catalog-count">~${catalog.estimated_products} productos</div>
                            </div>
                        `;
                    }
                }).join('');
                
                console.log('[Wizard] Cat√°logos mostrados:', data.catalogs.length);
            } catch (error) {
                console.error('[Wizard] Error:', error);
                alert('Error al cargar cat√°logos. Recarga la p√°gina.');
            }
        }

        // Nueva funci√≥n: Confirmar antes de cambiar cat√°logo
        async function confirmLoadCatalog(catalogCode, event) {
            const currentCatalog = await localDB.getConfig('catalog_code');
            
            if (currentCatalog && currentCatalog.value) {
                const confirm = window.confirm(
                    `‚ö†Ô∏è Ya tienes un cat√°logo cargado: ${currentCatalog.value}\n\n` +
                    `Si cargas "${catalogCode}", se borrar√°n todos los productos actuales.\n\n` +
                    `¬øContinuar?`
                );
                
                if (!confirm) return;
            }
            
            selectCatalog(catalogCode, event);
        }

        // ============================================
        // CERRAR WIZARD DE ONBOARDING
        // ============================================
        async function closeOnboardingWizard() {
            console.log('[Wizard] Cerrando wizard...');
            
            const modal = document.getElementById('onboarding-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            try {
                // Inicializar DB primero
                await localDB.init();
                
                // Verificar productos
                const products = await localDB.getProducts();
                console.log(`[Wizard] Productos en IndexedDB: ${products ? products.length : 0}`);
                
                if (products && products.length > 0) {
                    // Tiene productos, puede vender
                    console.log('[Wizard] ‚úÖ Usuario tiene productos, redirigiendo a home');
                    window.location.href = '/home';
                } else {
                    // No tiene productos
                    console.warn('[Wizard] ‚ö†Ô∏è Usuario no tiene productos');
                    
                    const wantsToContinue = confirm(
                        '‚ö†Ô∏è A√∫n no has cargado ning√∫n cat√°logo.\n\n' +
                        'Necesitas productos para poder vender.\n\n' +
                        '¬øDeseas seleccionar un cat√°logo ahora?'
                    );
                    
                    if (wantsToContinue) {
                        // Volver a mostrar wizard
                        showOnboardingWizard();
                    } else {
                        // Ir a home de todas formas (ver√° pantalla vac√≠a)
                        window.location.href = '/home';
                    }
                }
            } catch (error) {
                console.error('[Wizard] Error verificando productos:', error);
                // En caso de error, dejar ir a home
                window.location.href = '/home';
            }
        }

        //let selectedCatalogs = [];

        /*
        function toggleCatalog(catalogCode, event) {
            const checkbox = document.getElementById(`catalog-${catalogCode}`);
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                selectedCatalogs.push(catalogCode);
            } else {
                selectedCatalogs = selectedCatalogs.filter(c => c !== catalogCode);
            }
            
            // Actualizar bot√≥n
            const btn = document.getElementById('confirm-catalogs-btn');
            if (selectedCatalogs.length > 0) {
                btn.disabled = false;
                btn.textContent = `Cargar ${selectedCatalogs.length} cat√°logo(s) seleccionado(s)`;
                btn.style.opacity = '1';
            } else {
                btn.disabled = true;
                btn.textContent = 'Selecciona al menos un cat√°logo';
                btn.style.opacity = '0.5';
            }
        }
       */
        // ============================================
        // SELECCI√ìN DE CAT√ÅLOGO (CLICK DIRECTO)
        // ============================================
    async function selectCatalog(catalogCode, event) {
        const cards = document.querySelectorAll('.catalog-card');
        cards.forEach(card => card.classList.add('loading'));
        
        const selectedCard = event.currentTarget;
        selectedCard.innerHTML = '<div class="loading-spinner"></div><p>Preparando tienda...</p>';
        
        try {
            // 1. Desactivar productos existentes
            selectedCard.innerHTML = '<div class="loading-spinner"></div><p>Limpiando productos anteriores...</p>';
            
            const deactivateResponse = await fetch('/api/v1/products/deactivate-all', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            
            // No es cr√≠tico si falla (puede ser primera vez)
            if (!deactivateResponse.ok) {
                console.log('[Catalog] No hab√≠a productos previos o error al desactivar');
            }
            
            // 2. Copiar cat√°logo al servidor
            selectedCard.innerHTML = '<div class="loading-spinner"></div><p>Copiando cat√°logo...</p>';
            
            const copyResponse = await fetch(`/api/v1/catalogs/copy/${catalogCode}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ initial_stock: 200 })
            });
            
            // Validar respuesta
            if (!copyResponse.ok) {
                const errorText = await copyResponse.text();
                console.error('[Catalog] Error servidor:', errorText);
                throw new Error(`Error del servidor (${copyResponse.status})`);
            }
            
            // Verificar que sea JSON
            const contentType = copyResponse.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await copyResponse.text();
                console.error('[Catalog] Respuesta no es JSON:', text.substring(0, 200));
                throw new Error('El servidor retorn√≥ HTML en lugar de JSON');
            }
            
            const copyResult = await copyResponse.json();
            console.log('[Catalog] Resultado:', copyResult);
            
            if (!copyResult.success) {
                throw new Error(copyResult.message || 'Error al copiar cat√°logo');
            }
            
            // 3. Obtener productos del servidor
            selectedCard.innerHTML = '<div class="loading-spinner"></div><p>Descargando productos...</p>';
            
            const productsResponse = await fetch('/api/v1/products/json', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            
            if (!productsResponse.ok) {
                throw new Error(`Error obteniendo productos (${productsResponse.status})`);
            }
            
            const products = await productsResponse.json();
            console.log(`[Catalog] Productos descargados: ${products.length}`);
            
            if (!Array.isArray(products) || products.length === 0) {
                throw new Error('No se obtuvieron productos');
            }
            
            // 4. Guardar en IndexedDB
            selectedCard.innerHTML = '<div class="loading-spinner"></div><p>Guardando en tu dispositivo...</p>';
            
            await localDB.init();
            await localDB.saveProducts(products);
            await localDB.setConfig('catalog_code', catalogCode);
            await localDB.setConfig('last_sync', new Date().toISOString());

            // ‚¨áÔ∏è AGREGAR ESTA L√çNEA NUEVA:
            await localDB.addLoadedCatalog(catalogCode);  // üÜï Registrar cat√°logo como instalado
            
            console.log('[Catalog] Productos guardados en IndexedDB');
            console.log(`[Catalog] Cat√°logo ${catalogCode} marcado como instalado`);  // üÜï
            
            // üî• VERIFICAR INMEDIATAMENTE que se guard√≥:
            const loaded = await localDB.getLoadedCatalogs();
            console.log('[Catalog] Cat√°logos actualmente instalados:', loaded);

            // 5. Marcar onboarding como completado
            selectedCard.innerHTML = '<div class="loading-spinner"></div><p>Finalizando...</p>';
            
            const completeResponse = await fetch('/api/v1/stores/me/complete-onboarding', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            
            if (!completeResponse.ok) {
                console.warn('[Catalog] No se pudo marcar onboarding como completado');
            }
            
            // 6. √âxito con opciones de navegaci√≥n
            let autoRedirectInterval;

            selectedCard.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 300px;
                    padding: 30px;
                ">
                    <!-- √çcono de √©xito -->
                    <div style="
                        font-size: 80px;
                        margin-bottom: 20px;
                        animation: scaleIn 0.5s ease;
                    ">‚úÖ</div>
                    
                    <!-- T√≠tulo -->
                    <div style="
                        font-size: 28px;
                        font-weight: bold;
                        margin-bottom: 10px;
                        color: white;
                    ">¬°Cat√°logo cargado!</div>
                    
                    <!-- Info de productos -->
                    <div style="
                        font-size: 18px;
                        opacity: 0.9;
                        margin-bottom: 10px;
                        color: white;
                    ">
                        üì¶ ${products.length} productos listos
                    </div>
                    
                    <!-- Nombre del cat√°logo -->
                    <div style="
                        font-size: 16px;
                        opacity: 0.8;
                        margin-bottom: 30px;
                        color: white;
                    ">
                        üè∑Ô∏è ${catalogCode.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                    </div>
                    
                    <!-- Botones de acci√≥n -->
                    <div style="
                        display: flex;
                        gap: 15px;
                        flex-wrap: wrap;
                        justify-content: center;
                        margin-top: 20px;
                    ">
                        <button id="btn-go-sell" style="
                            padding: 18px 35px;
                            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 18px;
                            font-weight: bold;
                            cursor: pointer;
                            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        ">
                            üõí Empezar a vender
                        </button>
                        
                        <button id="btn-go-settings" style="
                            padding: 18px 35px;
                            background: rgba(255, 255, 255, 0.2);
                            color: white;
                            border: 2px solid white;
                            border-radius: 12px;
                            font-size: 18px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        ">
                            ‚öôÔ∏è Configuraci√≥n
                        </button>
                    </div>
                    
                    <!-- Mensaje de auto-redireccion -->
                    <div style="
                        margin-top: 25px;
                        font-size: 14px;
                        opacity: 0.7;
                        color: white;
                    " id="auto-redirect-msg">
                        Ser√°s redirigido en <span id="countdown">10</span> segundos...
                    </div>
                </div>
            `;

            // Agregar event listeners a los botones
            document.getElementById('btn-go-sell').addEventListener('click', () => {
                clearInterval(autoRedirectInterval);
                window.location.href = '/home';
            });

            document.getElementById('btn-go-settings').addEventListener('click', () => {
                clearInterval(autoRedirectInterval);
                window.location.href = '/settings';
            });

            // Auto-redirigir despu√©s de 10 segundos
            let countdown = 10;
            const countdownElement = document.getElementById('countdown');
            autoRedirectInterval = setInterval(() => {
                countdown--;
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                
                if (countdown <= 0) {
                    clearInterval(autoRedirectInterval);
                    window.location.href = '/home';
                }
            }, 1000);
            
        } catch (error) {
            console.error('[Catalog] Error completo:', error);
            
            selectedCard.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 10px;">‚ùå</div>
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Error</div>
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 15px;">${error.message}</div>
                <button onclick="showOnboardingWizard()" style="
                    padding: 10px 20px;
                    background: white;
                    color: #1e3c72;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: bold;
                ">Reintentar</button>
            `;
        }
    }
    </script>

    <script>
    // ‚úÖ ESTO SOLO EN home.html
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('access_token');
        
        if (!token || token === 'null' || token === 'undefined') {
            console.log('‚ùå No hay token, redirigiendo a login...');
            window.location.href = '/auth/login';
            return;
        }
        
        console.log('‚úÖ Token v√°lido encontrado');
    });

    // Configuraci√≥n HTMX
    document.body.addEventListener('htmx:configRequest', function(evt) {
        const token = localStorage.getItem('access_token');
        if (token && token !== 'null') {
            evt.detail.headers['Authorization'] = `Bearer ${token}`;
        }
    });

    document.body.addEventListener('htmx:responseError', function(evt) {
        if (evt.detail.xhr.status === 401) {
            localStorage.clear();
            window.location.href = '/auth/login';
        }
    });
    </script>
    
    <!-- 1. Cargar datos del usuario primero -->
    <script>
        // DEBUG: Verificar token al cargar
        console.log('üîê Token en localStorage:', localStorage.getItem('access_token') ? '‚úÖ Existe' : '‚ùå No existe');
        console.log('üë§ User:', localStorage.getItem('user'));

        // Funci√≥n para cargar datos del usuario desde localStorage
        function loadUserData() {
            try {
                const userStr = localStorage.getItem('user');
                const storeStr = localStorage.getItem('store');
                
                if (!userStr || !storeStr) {
                    console.error('[UserData] No hay datos de usuario en localStorage');
                    return;
                }
                
                const user = JSON.parse(userStr);
                const store = JSON.parse(storeStr);
                
                // Actualizar avatar (primera letra del nombre)
                const avatarEl = document.getElementById('user-avatar');
                if (avatarEl && user.full_name) {
                    avatarEl.textContent = user.full_name.charAt(0).toUpperCase();
                }
                
                // Actualizar nombre de tienda
                const storeNameEl = document.getElementById('store-name');
                if (storeNameEl && store.commercial_name) {
                    storeNameEl.textContent = store.commercial_name;
                }
                
                // Actualizar nombre de usuario
                const userNameEl = document.getElementById('user-name');
                if (userNameEl && user.full_name) {
                    userNameEl.textContent = user.full_name;
                }
                
                console.log('[UserData] ‚úÖ Datos del usuario cargados:', {
                    user: user.full_name,
                    store: store.commercial_name
                });
                
                // Exponer globalmente para otros scripts
                window.currentUser = user;
                window.currentStore = store;
                
            } catch (error) {
                console.error('[UserData] Error al cargar datos:', error);
            }
        }
        
        // Ejecutar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', loadUserData);
    </script>
    
    <!-- 2. Helper para peticiones autenticadas -->
    <script>
        // Funci√≥n helper para hacer peticiones con token JWT
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                console.error('[fetchWithAuth] No hay token, redirigiendo a login');
                window.location.href = '/auth/login';
                throw new Error('No authentication token');
            }
            
            // Merge headers
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });
                
                // Si es 401, token expirado
                if (response.status === 401) {
                    console.warn('[fetchWithAuth] Token expirado (401), redirigiendo a login');
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('user');
                    localStorage.removeItem('store');
                    window.location.href = '/auth/login';
                    throw new Error('Authentication expired');
                }
                
                return response;
            } catch (error) {
                console.error('[fetchWithAuth] Error en petici√≥n:', error);
                throw error;
            }
        }
        
        // Exponer globalmente
        window.fetchWithAuth = fetchWithAuth;
    </script>
    
    <!-- 3. Funci√≥n de logout -->
    <script>
        function handleLogout() {
            console.log('[Logout] Cerrando sesi√≥n...');
            
            // Limpiar localStorage
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            localStorage.removeItem('store');
            
            // Redirigir a login
            window.location.href = '/auth/login';
        }
        
        // Exponer globalmente
        window.handleLogout = handleLogout;
    </script>

    <!-- 4. Scripts originales de la aplicaci√≥n -->
    <script src="/static/js/db.js"></script>
    <script>
        // Inicializar DB global
        const localDB = new LocalDB();
        localDB.init().then(() => {
            console.log('‚úÖ IndexedDB inicializado');
        }).catch(err => {
            console.error('‚ùå Error inicializando DB:', err);
        });
    </script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/voice_system.js"></script>
    <script src="/static/js/tts_client.js"></script>
    <script src="/static/js/orientation.js"></script>
    <script src="/static/js/alerts.js"></script>
    
    <!-- 5. Helper para comandos de voz -->
    <script>
        function handleVoiceCommand(command) {
            if (typeof processCommand !== 'undefined') {
                processCommand(command);
            } else {
                console.error('[Voice] processCommand no est√° definido');
            }
        }
        
        // Exponer cart globalmente para alerts.js
        if (typeof cart !== 'undefined') {
            window.cart = cart;
        }
    </script>

    <!-- 6. Modal de comandos -->
    <script>
        function openCommandsModal() {
            console.log('[Modal] Abriendo modal de comandos');
            const modal = document.getElementById('voice-commands-modal');
            if (modal) {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('show'), 10);
            } else {
                console.error('[Modal] No se encontr√≥ el elemento voice-commands-modal');
            }
        }

        function closeCommandsModal() {
            console.log('[Modal] Cerrando modal');
            const modal = document.getElementById('voice-commands-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.style.display = 'none', 300);
            }
        }

        // Click fuera del modal para cerrar
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('voice-commands-modal');
            if (modal && e.target === modal) {
                closeCommandsModal();
            }
        });

        // Exponer globalmente
        window.openCommandsModal = openCommandsModal;
        window.closeCommandsModal = closeCommandsModal;
    </script>
    
    <!-- 7. Configurar HTMX con headers de autorizaci√≥n -->


    <script>
// ========================================
// FIX CORRECTO PARA MODAL DE COMANDOS
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    loadUserAvatar();
    console.log('[Fix] Aplicando correcciones de modal...');
    
    // 1. Ocultar modal SOLO al cargar (no forzar permanentemente)
    const modal = document.getElementById('voice-commands-modal');
    if (modal && !modal.classList.contains('show')) {
        modal.style.display = 'none';
        modal.style.pointerEvents = 'none';
        modal.style.opacity = '0';
        console.log('[Fix] ‚úÖ Modal ocultado inicialmente');
    }
    
    // 2. Funci√≥n para CERRAR modal
    window.closeVoiceCommandsModal = function() {
        console.log('[Modal] Cerrando...');
        const modal = document.getElementById('voice-commands-modal');
        if (modal) {
            modal.classList.remove('show');
            modal.style.opacity = '0';
            
            setTimeout(() => {
                modal.style.display = 'none';
                modal.style.pointerEvents = 'none';
            }, 300); // Esperar animaci√≥n
            
            console.log('[Modal] ‚úÖ Cerrado');
        }
    };
    
    // 3. Funci√≥n para ABRIR modal (CORREGIDA)
    window.openVoiceCommandsModal = function() {
        console.log('[Modal] Abriendo...');
        const modal = document.getElementById('voice-commands-modal');
        if (modal) {
            modal.classList.add('show');
            
            // ‚úÖ FORZAR con cssText (mayor prioridad)
            modal.style.cssText = `
                display: flex !important;
                opacity: 1 !important;
                pointer-events: auto !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 10000 !important;
                background: rgba(0, 0, 0, 0.85) !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            
            console.log('[Modal] ‚úÖ Abierto con estilos forzados');
        }
    };
    
    console.log('[Fix] ‚úÖ Funciones de modal configuradas');
});
    </script>

        <script>
        // ========================================
        // PARA CARGAR LA IMAAGEN DEL AVATAR
        // ========================================
        async function loadUserAvatar() {
            try {
                const user = JSON.parse(localStorage.getItem('user'));
                const avatar = document.getElementById('user-avatar');
                
                if (!user || !user.dni) {
                    // Usar iniciales
                    avatar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    avatar.style.fontSize = '24px';
                    avatar.style.display = 'flex';
                    avatar.style.alignItems = 'center';
                    avatar.style.justifyContent = 'center';
                    avatar.style.color = 'white';
                    avatar.style.fontWeight = 'bold';
                    avatar.innerHTML = '?';
                    avatar.removeAttribute('src');
                    return;
                }
                
                const imgPath = `/static/img/${user.dni}.jpg`;
                
                const img = new Image();
                img.onload = () => {
                    avatar.src = imgPath;
                };
                img.onerror = () => {
                    // Fallback: Mostrar iniciales
                    const initials = user.full_name 
                        ? user.full_name.split(' ').map(n => n[0]).join('').substring(0, 2) 
                        : '??';
                    avatar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    avatar.style.fontSize = '24px';
                    avatar.style.display = 'flex';
                    avatar.style.alignItems = 'center';
                    avatar.style.justifyContent = 'center';
                    avatar.style.color = 'white';
                    avatar.style.fontWeight = 'bold';
                    avatar.innerHTML = initials;
                    avatar.removeAttribute('src');
                };
                img.src = imgPath;
            } catch (error) {
                console.log('[Avatar] Error loading:', error);
            }
        }
        
        </script>

        <script>
        // Variables globales para avatar
        let selectedFile = null;

        

        function openAvatarModal() {
            document.getElementById('avatar-modal').style.display = 'flex';
        }

        function closeAvatarModal() {
            document.getElementById('avatar-modal').style.display = 'none';
            selectedFile = null;
            document.getElementById('btn-upload-avatar').style.display = 'none';
        }

        function handleAvatarSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tipo
            if (!file.type.startsWith('image/')) {
                alert('‚ùå Por favor selecciona una imagen');
                return;
            }
            
            // Validar tama√±o (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå La imagen es muy grande. M√°ximo 5MB');
                return;
            }
            
            selectedFile = file;
            
            // Preview local
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('avatar-preview').src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Mostrar bot√≥n de subir
            document.getElementById('btn-upload-avatar').style.display = 'inline-block';
        }

        async function uploadAvatar() {
            if (!selectedFile) {
                alert('‚ùå Selecciona una imagen primero');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            const btnUpload = document.getElementById('btn-upload-avatar');
            const originalText = btnUpload.textContent;
            btnUpload.textContent = '‚è≥ Subiendo...';
            btnUpload.disabled = true;
            
            try {
                const response = await fetch('/api/v1/users/avatar/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Actualizar avatar en header (con timestamp para evitar cach√©)
                    const avatarUrl = `${result.avatar_url}?t=${Date.now()}`;
                    document.getElementById('user-avatar').src = avatarUrl;
                    
                    // Cerrar modal
                    closeAvatarModal();
                    
                    // Notificaci√≥n de √©xito
                    showAlert('‚úì Foto actualizada exitosamente', 'success');
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('[Avatar] Upload error:', error);
                showAlert('‚ùå Error al subir la foto', 'error');
            } finally {
                btnUpload.textContent = originalText;
                btnUpload.disabled = false;
            }
        }

        // Funci√≥n helper para mostrar notificaciones
        function showAlert(message, type = 'info') {
            // Si ya tienes un sistema de alertas, √∫salo
            // Si no, este es un fallback simple
            alert(message);
        }

        // Cargar avatar cuando cargue la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar un poco para que el token est√© disponible
            setTimeout(() => {
                loadUserAvatar();
            }, 500);
        });
        </script>

        <script>

            // DESHABILITADO TEMPORALMENTE - definir estrategia offline primero
            /*
            if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                .then(reg => console.log('‚úÖ SW registrado:', reg))
                .catch(err => console.error('‚ùå Error SW:', err));
            });
            }
            */
            console.log('‚ö†Ô∏è Service Worker deshabilitado - definiendo estrategia offline');

        </script>

        <script>
            // Funci√≥n para restablecer cat√°logo (debe usarse con precauci√≥n y solo por el usuario DUE√ëO)
        async function resetCatalog() {
            if (!confirm('‚ö†Ô∏è Esto desactivar√° TODOS tus productos actuales. ¬øEst√°s seguro?')) {
                return;
            }
            
            if (!confirm('üö® √öLTIMA CONFIRMACI√ìN: ¬øRealmente quieres empezar de cero?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/v1/products/reset-catalog', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Cat√°logo restablecido. Recargando...');
                    window.location.reload();
                }
            } catch (error) {
                alert('‚ùå Error al restablecer');
            }
        }
        </script>


    <!-- ============================================ -->
    <!-- MODAL DE FIADOS -->
    <!-- ============================================ -->
    <div id="fiados-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h2 style="margin: 0; color: white;">üí≥ Venta a Cr√©dito (Fiado)</h2>
                <button onclick="closeFiadosModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">‚úï</button>
            </div>

            <div class="modal-body" style="padding: 20px;">
                <!-- Resumen de la venta actual -->
                <div id="fiado-cart-summary" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #94a3b8;">Venta actual:</div>
                    <div id="fiado-total" style="font-size: 28px; font-weight: bold; color: #4ade80;">S/. 0.00</div>
                </div>

                <!-- Formulario del cliente -->
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px;">Nombre del cliente *</label>
                        <input type="text" id="fiado-customer-name" placeholder="Nombre completo" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px;">Tel√©fono *</label>
                        <input type="tel" id="fiado-customer-phone" placeholder="999 999 999" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px;">DNI (opcional)</label>
                        <input type="text" id="fiado-customer-dni" placeholder="12345678" maxlength="8" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px;">D√≠as de cr√©dito</label>
                        <select id="fiado-credit-days" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(30,30,40,0.9); color: white; font-size: 16px;">
                            <option value="7">7 d√≠as</option>
                            <option value="15">15 d√≠as</option>
                            <option value="30" selected>30 d√≠as</option>
                            <option value="60">60 d√≠as</option>
                        </select>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px;">Notas (opcional)</label>
                        <textarea id="fiado-notes" placeholder="Observaciones..." rows="2" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 16px; resize: none;"></textarea>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="closeFiadosModal()" style="flex: 1; padding: 15px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: white; font-size: 16px; cursor: pointer;">
                        Cancelar
                    </button>
                    <button onclick="confirmarFiado()" style="flex: 2; padding: 15px; background: linear-gradient(135deg, #4ade80, #22c55e); border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer;">
                        ‚úì Registrar Fiado
                    </button>
                </div>

                <!-- Link a cobrar fiados -->
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <a href="/cobrar-fiados" style="color: #60a5fa; text-decoration: none; font-size: 14px;">
                        üìã Ver todos los fiados pendientes ‚Üí
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL DE EMITIR BOLETA/FACTURA -->
    <!-- ============================================ -->
    <div id="boleta-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h2 style="margin: 0; color: white;">üìÑ Venta Completada</h2>
                <button onclick="closeBoletaModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">‚úï</button>
            </div>

            <div class="modal-body" style="padding: 25px;">
                <!-- Resumen de venta -->
                <div style="background: rgba(74, 222, 128, 0.2); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #94a3b8;">Total de venta</div>
                    <div id="boleta-total" style="font-size: 36px; font-weight: bold; color: #4ade80;">S/. 0.00</div>
                </div>

                <p style="color: #94a3b8; margin-bottom: 20px;">¬øDeseas emitir comprobante electr√≥nico?</p>

                <!-- Botones de acci√≥n -->
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button onclick="emitirBoleta()" id="btn-emitir-boleta" style="
                        padding: 15px;
                        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                        border: none;
                        border-radius: 8px;
                        color: white;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    ">
                        üìÑ Emitir Boleta
                    </button>

                    <button onclick="emitirFactura()" id="btn-emitir-factura" style="
                        padding: 15px;
                        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
                        border: none;
                        border-radius: 8px;
                        color: white;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    ">
                        üßæ Emitir Factura
                    </button>

                    <button onclick="closeBoletaModal()" style="
                        padding: 15px;
                        background: rgba(255,255,255,0.1);
                        border: none;
                        border-radius: 8px;
                        color: #94a3b8;
                        font-size: 16px;
                        cursor: pointer;
                    ">
                        Solo ticket (sin comprobante)
                    </button>
                </div>

                <!-- Estado de facturaci√≥n -->
                <div id="boleta-status" style="margin-top: 15px; display: none;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; color: #60a5fa;">
                        <div class="spinner" style="width: 20px; height: 20px; border: 3px solid rgba(96, 165, 250, 0.3); border-top-color: #60a5fa; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span id="boleta-status-text">Emitiendo comprobante...</span>
                    </div>
                </div>

                <!-- Resultado -->
                <div id="boleta-result" style="margin-top: 15px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal para datos de factura (RUC) -->
    <div id="factura-datos-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h2 style="margin: 0; color: white;">üßæ Datos para Factura</h2>
                <button onclick="closeFacturaDatosModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">‚úï</button>
            </div>

            <div class="modal-body" style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px;">RUC *</label>
                        <input type="text" id="factura-ruc" placeholder="20123456789" maxlength="11" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 18px; letter-spacing: 1px;">
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px;">Raz√≥n Social *</label>
                        <input type="text" id="factura-razon-social" placeholder="EMPRESA S.A.C." style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px;">Direcci√≥n (opcional)</label>
                        <input type="text" id="factura-direccion" placeholder="Av. Principal 123" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="closeFacturaDatosModal()" style="flex: 1; padding: 15px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: white; font-size: 16px; cursor: pointer;">
                        Cancelar
                    </button>
                    <button onclick="confirmarFactura()" style="flex: 2; padding: 15px; background: linear-gradient(135deg, #8b5cf6, #6d28d9); border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer;">
                        Emitir Factura
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts de Boleta -->
    <script>
        // Variables para el modal de boleta
        let lastSaleId = null;
        let lastSaleTotal = 0;
        let facturacionConfigurada = false;

        // Verificar si facturaci√≥n est√° configurada
        async function checkBillingConfig() {
            try {
                const response = await fetchWithAuth('/api/v1/billing/config');
                const data = await response.json();
                facturacionConfigurada = data.configured && data.config?.is_active;
                console.log('[Billing] Configurado:', facturacionConfigurada);
            } catch (error) {
                console.log('[Billing] No configurado');
                facturacionConfigurada = false;
            }
        }

        // Llamar al cargar
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkBillingConfig, 1000);
        });

        function showBoletaModal(saleId, total) {
            // Verificar si facturaci√≥n est√° configurada
            if (!facturacionConfigurada) {
                console.log('[Billing] Facturaci√≥n no configurada, no mostrar modal');
                return;
            }

            lastSaleId = saleId;
            lastSaleTotal = total;

            document.getElementById('boleta-total').textContent = `S/. ${total.toFixed(2)}`;
            document.getElementById('boleta-status').style.display = 'none';
            document.getElementById('boleta-result').style.display = 'none';
            document.getElementById('btn-emitir-boleta').disabled = false;
            document.getElementById('btn-emitir-factura').disabled = false;

            const modal = document.getElementById('boleta-modal');
            modal.style.display = 'flex';
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.85) !important;
                z-index: 10002 !important;
                align-items: center !important;
                justify-content: center !important;
            `;
        }

        function closeBoletaModal() {
            document.getElementById('boleta-modal').style.display = 'none';
            lastSaleId = null;
            lastSaleTotal = 0;
        }

        async function emitirBoleta() {
            if (!lastSaleId) return;

            const btnBoleta = document.getElementById('btn-emitir-boleta');
            const btnFactura = document.getElementById('btn-emitir-factura');
            const status = document.getElementById('boleta-status');
            const statusText = document.getElementById('boleta-status-text');
            const result = document.getElementById('boleta-result');

            btnBoleta.disabled = true;
            btnFactura.disabled = true;
            status.style.display = 'block';
            statusText.textContent = 'Emitiendo boleta...';

            try {
                const response = await fetchWithAuth(`/api/v1/billing/emitir/boleta/${lastSaleId}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    status.style.display = 'none';
                    result.style.display = 'block';
                    result.innerHTML = `
                        <div style="background: rgba(74, 222, 128, 0.2); padding: 15px; border-radius: 8px;">
                            <div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">‚úÖ Boleta emitida</div>
                            <div style="color: white; font-size: 18px; font-weight: bold;">${data.numero_formato}</div>
                            ${data.pdf_url ? `<a href="${data.pdf_url}" target="_blank" style="display: inline-block; margin-top: 10px; color: #60a5fa; text-decoration: none;">üì• Descargar PDF</a>` : ''}
                        </div>
                    `;

                    // Cerrar autom√°ticamente despu√©s de 3 segundos
                    setTimeout(closeBoletaModal, 3000);
                } else {
                    throw new Error(data.detail || data.error || 'Error al emitir');
                }
            } catch (error) {
                status.style.display = 'none';
                result.style.display = 'block';
                result.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.2); padding: 15px; border-radius: 8px; color: #f87171;">
                        ‚ùå ${error.message}
                    </div>
                `;
                btnBoleta.disabled = false;
                btnFactura.disabled = false;
            }
        }

        function emitirFactura() {
            // Cerrar modal de boleta
            document.getElementById('boleta-modal').style.display = 'none';

            // Abrir modal de datos de factura
            const modal = document.getElementById('factura-datos-modal');
            modal.style.display = 'flex';
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.85) !important;
                z-index: 10003 !important;
                align-items: center !important;
                justify-content: center !important;
            `;

            document.getElementById('factura-ruc').value = '';
            document.getElementById('factura-razon-social').value = '';
            document.getElementById('factura-direccion').value = '';
            document.getElementById('factura-ruc').focus();
        }

        function closeFacturaDatosModal() {
            document.getElementById('factura-datos-modal').style.display = 'none';
        }

        async function confirmarFactura() {
            const ruc = document.getElementById('factura-ruc').value.trim();
            const razonSocial = document.getElementById('factura-razon-social').value.trim();
            const direccion = document.getElementById('factura-direccion').value.trim();

            if (!ruc || ruc.length !== 11) {
                alert('‚ùå Ingresa un RUC v√°lido (11 d√≠gitos)');
                document.getElementById('factura-ruc').focus();
                return;
            }

            if (!razonSocial) {
                alert('‚ùå Ingresa la raz√≥n social');
                document.getElementById('factura-razon-social').focus();
                return;
            }

            try {
                const response = await fetchWithAuth('/api/v1/billing/emitir', {
                    method: 'POST',
                    body: JSON.stringify({
                        sale_id: lastSaleId,
                        tipo: '01',
                        cliente_tipo_doc: '6',
                        cliente_num_doc: ruc,
                        cliente_nombre: razonSocial,
                        cliente_direccion: direccion || null
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    closeFacturaDatosModal();
                    alert(`‚úÖ Factura emitida: ${data.numero_formato}`);
                    if (data.pdf_url) {
                        window.open(data.pdf_url, '_blank');
                    }
                } else {
                    throw new Error(data.detail || data.error || 'Error al emitir factura');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Exponer funciones globalmente
        window.showBoletaModal = showBoletaModal;
        window.closeBoletaModal = closeBoletaModal;
        window.emitirBoleta = emitirBoleta;
        window.emitirFactura = emitirFactura;
        window.closeFacturaDatosModal = closeFacturaDatosModal;
        window.confirmarFactura = confirmarFactura;
    </script>

    <!-- Scripts de Fiados -->
    <script>
        // Variables para el modal de fiados
        let currentCartForFiado = [];
        let currentTotalForFiado = 0;

        function openFiadosModal() {
            console.log('[Fiados] Abriendo modal...');

            // Verificar si hay carrito
            if (typeof cart === 'undefined' || !cart.items || cart.items.length === 0) {
                alert('‚ö†Ô∏è El carrito est√° vac√≠o. Agrega productos antes de fiar.');
                return;
            }

            // Guardar datos del carrito
            currentCartForFiado = [...cart.items];
            currentTotalForFiado = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // Mostrar total en el modal
            document.getElementById('fiado-total').textContent = `S/. ${currentTotalForFiado.toFixed(2)}`;

            // Limpiar campos
            document.getElementById('fiado-customer-name').value = '';
            document.getElementById('fiado-customer-phone').value = '';
            document.getElementById('fiado-customer-dni').value = '';
            document.getElementById('fiado-notes').value = '';

            // Mostrar modal
            const modal = document.getElementById('fiados-modal');
            modal.style.display = 'flex';
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.85) !important;
                z-index: 10001 !important;
                align-items: center !important;
                justify-content: center !important;
            `;

            // Focus en nombre
            setTimeout(() => {
                document.getElementById('fiado-customer-name').focus();
            }, 100);
        }

        function closeFiadosModal() {
            const modal = document.getElementById('fiados-modal');
            modal.style.display = 'none';
            currentCartForFiado = [];
            currentTotalForFiado = 0;
        }

        async function confirmarFiado() {
            const customerName = document.getElementById('fiado-customer-name').value.trim();
            const customerPhone = document.getElementById('fiado-customer-phone').value.trim();
            const customerDni = document.getElementById('fiado-customer-dni').value.trim();
            const creditDays = parseInt(document.getElementById('fiado-credit-days').value);
            const notes = document.getElementById('fiado-notes').value.trim();

            // Validaciones
            if (!customerName) {
                alert('‚ùå Ingresa el nombre del cliente');
                document.getElementById('fiado-customer-name').focus();
                return;
            }

            if (!customerPhone) {
                alert('‚ùå Ingresa el tel√©fono del cliente');
                document.getElementById('fiado-customer-phone').focus();
                return;
            }

            if (currentTotalForFiado <= 0) {
                alert('‚ùå El monto debe ser mayor a 0');
                return;
            }

            try {
                // 1. Primero crear la venta como pendiente
                const saleResponse = await fetchWithAuth('/api/v1/sales', {
                    method: 'POST',
                    body: JSON.stringify({
                        items: currentCartForFiado.map(item => ({
                            product_id: item.id,
                            quantity: item.quantity,
                            unit_price: item.price
                        })),
                        payment_method: 'fiado',
                        payment_status: 'pending',
                        is_credit: true,
                        customer_name: customerName,
                        customer_phone: customerPhone,
                        customer_dni: customerDni || null
                    })
                });

                if (!saleResponse.ok) {
                    const error = await saleResponse.json();
                    throw new Error(error.detail || 'Error al crear venta');
                }

                const saleData = await saleResponse.json();
                console.log('[Fiados] Venta creada:', saleData);

                // 2. Registrar el fiado
                const fiadoResponse = await fetchWithAuth('/api/v1/fiados/registrar', {
                    method: 'POST',
                    body: JSON.stringify({
                        customer_name: customerName,
                        customer_phone: customerPhone,
                        customer_address: '',
                        customer_dni: customerDni || null,
                        sale_id: saleData.id,
                        total_amount: currentTotalForFiado,
                        credit_days: creditDays,
                        notes: notes || null
                    })
                });

                if (!fiadoResponse.ok) {
                    const error = await fiadoResponse.json();
                    throw new Error(error.detail || 'Error al registrar fiado');
                }

                const fiadoData = await fiadoResponse.json();
                console.log('[Fiados] ‚úÖ Fiado registrado:', fiadoData);

                // 3. Limpiar carrito
                if (typeof clearCart === 'function') {
                    clearCart();
                } else if (typeof cart !== 'undefined') {
                    cart.items = [];
                    if (typeof updateCartDisplay === 'function') {
                        updateCartDisplay();
                    }
                }

                // 4. Cerrar modal y notificar
                closeFiadosModal();

                // Disparar evento para actualizar lista de ventas
                document.body.dispatchEvent(new CustomEvent('salesUpdated'));

                alert(`‚úÖ Fiado registrado para ${customerName}\nMonto: S/. ${currentTotalForFiado.toFixed(2)}\nVence en ${creditDays} d√≠as`);

            } catch (error) {
                console.error('[Fiados] Error:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Exponer funciones globalmente
        window.openFiadosModal = openFiadosModal;
        window.closeFiadosModal = closeFiadosModal;
        window.confirmarFiado = confirmarFiado;

        // Click fuera del modal para cerrar
        document.getElementById('fiados-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeFiadosModal();
            }
        });
    </script>

    <!-- Agregar esto en el men√∫ o header, donde sea apropiado -->
    <script>
        // Mostrar bot√≥n de configuraci√≥n solo a owners
        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (user && user.role === 'owner') {
                // Agregar bot√≥n de configuraci√≥n
                const header = document.querySelector('.header-actions'); // Ajusta el selector
                if (header) {
                    header.insertAdjacentHTML('beforeend', `
                        <a href="/settings" style="
                            padding: 10px 20px;
                            background: rgba(255, 255, 255, 0.2);
                            color: white;
                            text-decoration: none;
                            border-radius: 8px;
                            margin-left: 10px;
                        ">
                            ‚öôÔ∏è Configuraci√≥n
                        </a>
                    `);
                }
            }
        });
    </script>
</body>
</html>